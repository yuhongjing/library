---
title: å‡½æ•°ç»„ä»¶
---

# å‡½æ•°ç»„ä»¶

ç›®å‰æˆ‘ä»¬è¿˜åªè€ƒè™‘äº†ç›´æ¥æ¸²æŸ“ DOM æ ‡ç­¾çš„æƒ…å†µï¼Œä¸æ”¯æŒç»„ä»¶ï¼Œè€Œç»„ä»¶æ˜¯ React çš„çµé­‚ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å®ç°å‡½æ•°ç»„ä»¶ã€‚

ä»¥ä¸€ä¸ªéå¸¸ç®€å•çš„ç»„ä»¶ä»£ç ä¸ºä¾‹ã€‚

```js
/** @jsx Redact.createElement */
function App(props) {
  return <h1>Hi {props.name}</h1>;
};

// ç­‰æ•ˆ JS ä»£ç ğŸ‘‡
function App(props) {
  return Redact.craeteElement(
    "h1",
    null,
    "Hi ",
    props.name
  );
}

const element = <App name="foo" />;
const container = document.getElementById("root");
Redact.render(element, container);
```

å‡½æ•°ç»„ä»¶æœ‰2ä¸ªä¸åŒç‚¹ï¼š

* å‡½æ•°ç»„ä»¶çš„ fiber èŠ‚ç‚¹æ²¡æœ‰å¯¹åº”çš„ DOM
* å‡½æ•°ç»„ä»¶çš„ children æ¥è‡ªå‡½æ•°æ‰§è¡Œç»“æœï¼Œè€Œä¸åƒæ ‡ç­¾å…ƒç´ ä¸€æ ·ç›´æ¥ä» propsè·å–ï¼Œå› ä¸º children ä¸åªæ˜¯å‡½æ•°ç»„ä»¶ä½¿ç”¨æ—¶åŒ…å«çš„å­å­™èŠ‚ç‚¹ï¼Œè¿˜éœ€è¦ç»„åˆç»„ä»¶æœ¬èº«çš„ç»“æ„

æ³¨æ„ï¼šä»¥ä¸‹ä»£ç çœç•¥äº†æœªæ”¹åŠ¨éƒ¨åˆ†ã€‚

```js
function commitWork(fiber) {
  if (!fiber) {
    return;
  }
  
  // å½“ fiber æ˜¯å‡½æ•°ç»„ä»¶æ—¶èŠ‚ç‚¹ä¸å­˜åœ¨ DOM
  // æ•…éœ€è¦éå†çˆ¶èŠ‚ç‚¹ä»¥æ‰¾åˆ°æœ€è¿‘çš„æœ‰ DOM çš„èŠ‚ç‚¹
  let domParentFiber = fiber.parent;
  while (!domParentFiber.dom) {
    domParentFiber = domParentFiber.parent;
  }
  const domParent = domParentFiber.dom;
  if (fiber.effectTag === "PLACEMENT" && fiber.dom != null) {
    domParent.appendChild(fiber.dom);
  } else if (fiber.effectTag === "UPDATE" && fiber.dom != null) {
    updateDom(fiber.dom, fiber.alternate.props, fiber.props);
  } else if (fiber.effectTag === "DELETION") {
    // ç›´æ¥ç§»é™¤ DOM æ›¿æ¢æˆ commitDeletion å‡½æ•°
    commitDeletion(fiber, domParent);
  }
  
  commitWork(fiber.child);
  commitWork(fiber.sibling);
}

// æ–°å¢å‡½æ•°ï¼Œç§»é™¤ DOM èŠ‚ç‚¹
function commitDeletion(fiber, domParent) {
  // å½“ child æ˜¯å‡½æ•°ç»„ä»¶æ—¶ä¸å­˜åœ¨ DOM
  // æ•…éœ€è¦é€’å½’éå†å­èŠ‚ç‚¹æ‰¾åˆ°çœŸæ­£çš„ DOM
  if (fiber.dom) {
    domParent.removeChild(fiber.dom);
  } else {
    commitDeletion(fiber.child, domParent);
  }
}

function performUnitOfWork(fiber) {
  const isFunctionComponent = fiber.type instanceof Function;
  // åŸæœ¬é€»è¾‘æŒªåˆ° updateHostComponent å‡½æ•°
  if (isFunctionComponent) {
    updateFunctionComponent(fiber);
  } else {
    updateHostComponent(fiber);
  }
  if (fiber.child) {
    return fiber.child;
  }
  let nextFiber = fiber;
  while (nextFiber) {
    if (nextFiber.sibling) {
      return nextFiber.sibling;
    }
    nextFiber = nextFiber.parent;
  }
}

// æ–°å¢å‡½æ•°ï¼Œå¤„ç†å‡½æ•°ç»„ä»¶
function updateFunctionComponent(fiber) {
  // æ‰§è¡Œå‡½æ•°ç»„ä»¶å¾—åˆ° children
  const children = [fiber.type(fiber.props)];
  reconcileChlidren(fiber, children);
}

// æ–°å¢å‡½æ•°ï¼Œå¤„ç†åŸç”Ÿæ ‡ç­¾ç»„ä»¶
function updateHostComponent(fiber) {
  if (!fiber.dom) {
    fiber.dom = createDom(fiber);
  }
  reconcileChildren(fiber, fiber.props.children);
}
```

