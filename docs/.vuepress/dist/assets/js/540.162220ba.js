(window.webpackJsonp=window.webpackJsonp||[]).push([[540],{910:function(t,s,a){"use strict";a.r(s);var e=a(28),r=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"react-中的优先级管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#react-中的优先级管理"}},[t._v("#")]),t._v(" React 中的优先级管理")]),t._v(" "),a("blockquote",[a("p",[a("code",[t._v("React")]),t._v("内部对于"),a("code",[t._v("优先级")]),t._v("的管理，根据功能的不同分为"),a("code",[t._v("LanePriority")]),t._v("，"),a("code",[t._v("SchedulerPriority")]),t._v("，"),a("code",[t._v("ReactPriority")]),t._v(" 3 种类型，本文基于"),a("code",[t._v("react@17.0.2")]),t._v("，梳理源码中的优先级管理体系。")])]),t._v(" "),a("p",[a("code",[t._v("React")]),t._v("是一个声明式，高效且灵活的用于构建用户界面的 JavaScript 库。React团队一直致力于实现高效渲染，其中有 2 个十分有名的演讲：")]),t._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"http://conf2017.reactjs.org/speakers/lin",target:"_blank",rel:"noopener noreferrer"}},[t._v("2017 年 Lin Clark 的演讲"),a("OutboundLink")],1),t._v("中介绍了"),a("code",[t._v("fiber")]),t._v("架构和"),a("code",[t._v("可中断渲染")]),t._v("。")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://zh-hans.legacy.reactjs.org/blog/2018/03/01/sneak-peek-beyond-react-16.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("2018 年 Dan 在 JSConf 冰岛的演讲"),a("OutboundLink")],1),t._v("进一步介绍了时间切片("),a("code",[t._v("time slicing")]),t._v(")和异步渲染("),a("code",[t._v("suspense")]),t._v(")等特性。")])]),t._v(" "),a("p",[t._v("在"),a("code",[t._v("React@17.0.2")]),t._v("源码中，一共有"),a("code",[t._v("2套优先级体系")]),t._v("和"),a("code",[t._v("1套转换体系")]),t._v("，在深入分析之前，再次回顾一下(reconciler 运作流程)：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/yuhongjing/img-folder/master/img/reactfiberworkloop.b647e134.png",alt:""}})]),t._v(" "),a("p",[a("code",[t._v("React")]),t._v("内部对于"),a("code",[t._v("优先级")]),t._v("的管理，贯穿运作流程的 4 个阶段(从输入到输出)，根据其功能的不同，可以分为 3 种类型：")]),t._v(" "),a("ol",[a("li",[a("code",[t._v("fiber")]),t._v("优先级("),a("code",[t._v("LanePriority")]),t._v(")：位于"),a("code",[t._v("react-reconciler")]),t._v("包，也就是"),a("code",[t._v("Lane(车道模型)")]),t._v("。")]),t._v(" "),a("li",[t._v("调度优先级("),a("code",[t._v("SchedulerPriority")]),t._v(")：位于"),a("code",[t._v("scheduler")]),t._v("包。")]),t._v(" "),a("li",[t._v("优先级等级("),a("code",[t._v("ReactPriorityLevel")]),t._v(")：位于"),a("code",[t._v("react-reconciler")]),t._v("包中的"),a("code",[t._v("SchedulerWithReactIntegration.js")]),t._v("，负责上述 2 套优先级体系的转换。")])]),t._v(" "),a("h2",{attrs:{id:"预备知识"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#预备知识"}},[t._v("#")]),t._v(" 预备知识")]),t._v(" "),a("p",[t._v("在深入分析 3 种优先级之前，为了深入理解"),a("code",[t._v("LanePriority")]),t._v("，需要先了解"),a("code",[t._v("Lane")]),t._v("，这是"),a("code",[t._v("react@17.0.0")]),t._v("的新特性。")]),t._v(" "),a("h3",{attrs:{id:"lane-车道模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#lane-车道模型"}},[t._v("#")]),t._v(" Lane（车道模型）")]),t._v(" "),a("blockquote",[a("p",[t._v("英文单词"),a("code",[t._v("lane")]),t._v('翻译成中文表示"车道，航道"的意思，所以很多文章都将'),a("code",[t._v("Lanes")]),t._v("模型称为"),a("code",[t._v("车道模型")])])]),t._v(" "),a("p",[a("code",[t._v("Lane")]),t._v("模型的源码在ReactFiberLane.js，源码中大量使用了位运算(有关位运算的讲解，可以参考"),a("a",{attrs:{href:"../algorithm/%E4%BD%8D%E8%BF%90%E7%AE%97"}},[t._v("React 算法之位运算")]),t._v(")")]),t._v(" "),a("p",[t._v("首先引入作者对"),a("code",[t._v("Lane")]),t._v("的解释("),a("a",{attrs:{href:"https://github.com/facebook/react/pull/18796",target:"_blank",rel:"noopener noreferrer"}},[t._v("相应的 pr"),a("OutboundLink")],1),t._v(")，这里简单概括如下：")]),t._v(" "),a("ol",[a("li",[a("code",[t._v("Lane")]),t._v("类型被定义为二进制变量，利用了位掩码的特性，在频繁运算的时候占用内存少，计算速度快。\n"),a("ul",[a("li",[a("code",[t._v("Lane")]),t._v("和"),a("code",[t._v("Lanes")]),t._v("就是单数和复数的关系，代表单个任务的定义为"),a("code",[t._v("Lane")]),t._v("，代表多个任务的定义为"),a("code",[t._v("Lanes")])])])]),t._v(" "),a("li",[a("code",[t._v("Lane")]),t._v("是对于"),a("code",[t._v("expirationTime")]),t._v("的重构，以前使用"),a("code",[t._v("expirationTime")]),t._v("表示的字段，都改为了"),a("code",[t._v("lane")])])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("renderExpirationTime -> renderLanes\nupdate.expirationTime -> update.lane\nfiber.expirationTime -> fiber.lanes\nfiber.childExpirationTime -> fiber.childLanes\nroot.firstPendingTime and root.lastPendingTime -> fiber.pendingLanes\n")])])]),a("ol",{attrs:{start:"3"}},[a("li",[a("p",[t._v("使用"),a("code",[t._v("Lanes")]),t._v("模式相比"),a("code",[t._v("expirationTime")]),t._v("模型的优势：")]),t._v(" "),a("ol",[a("li",[a("code",[t._v("Lanes")]),t._v("把任务优先级从批量任务中分离出来，可以更方便的判断单个任务与批量任务的优先级是否重叠")])]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 判断：单task与batchTask的优先级是否重叠")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 通过expirationTime判断")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" isTaskIncludedInBatch "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" priorityOfTast "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" priorityOfBatch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 通过Lanes判断")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" isTaskIncludedInBatch "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("task "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" batchOfTasks"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 当同时处理一组任务，该组内有多个任务，且每个任务的优先级不一致")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 如果通过expirationTime判断，需要维护一个范围(在Lane重构之前，源码中就是这样比较的)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" isTaskIncludedInBatch "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n\ttaskPriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" highestPriorityInRange "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n  taskPriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" lowestPriorityInRange"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 通过Lanes判断")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" isTaskIncludedInBatch "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("task "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" batchOfTasks"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[a("code",[t._v("Lanes")]),t._v("使用单个32位二进制变量即可代表多个不同的任务，也就是说一个变量即可代表一个组("),a("code",[t._v("group")]),t._v(")，如果要在一个 group 中分离出单个task，非常容易")])]),t._v(" "),a("blockquote",[a("p",[t._v("在"),a("code",[t._v("expirationTime")]),t._v("模型设计之初， react 体系中还没有Suspense异步渲染的概念。")]),t._v(" "),a("p",[t._v("现在有如下场景：有3个任务，其优先级"),a("code",[t._v("A > B > C")]),t._v("，正常来讲只需要按照优先级顺序执行就可以了。")]),t._v(" "),a("p",[t._v("但是现在情况变了，A和C任务是"),a("code",[t._v("CPU密集型")]),t._v("，而B是"),a("code",[t._v("IO密集型")]),t._v("(Suspense会调用远程 api，算是IO任务)，")]),t._v(" "),a("p",[t._v("即"),a("code",[t._v("A(cpu) > B(IO) > C(cpu)")]),t._v("。此时的需求需要将任务"),a("code",[t._v("B")]),t._v("从group中分离出来，先处理cpu任务"),a("code",[t._v("A和C")]),t._v("。")])]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 从group中删除或增加task")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 通过expirationTime实现")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//  0) 维护一个链表，按照单个task的优先级顺序进行插入")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//  1) 删除单个task（从链表中删除一个元素）")]),t._v("\ntask"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prev"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("next "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("next"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//  2) 增加单个task（需要对比当前task的优先级，插入到链表正确的位置上）")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" current "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" queue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("expirationTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" current"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("expirationTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  current "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" current"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("next"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\ntask"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("next "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" current"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("next"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\ncurrent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("next "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//  3) 比较task是否在group中")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" isTaskIncludedInBatch "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n\ttaskPriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" highestPriorityInRange "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n  taskPriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" lowestPriorityInRange"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 通过Lanes实现")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//  1) 删除单个task")]),t._v("\nbatchOfTasks "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),t._v("task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//  2) 增加单个task")]),t._v("\nbatchOfTasks "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|=")]),t._v(" task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//  3) 比较task是否在group中")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" isTaskIncludedInBatch "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("task "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" batchOfTasks"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("通过上述伪代码，可以看到"),a("code",[t._v("Lanes")]),t._v("的优越性，运用起来代码量少，简洁高效。")])]),t._v(" "),a("li",[a("p",[a("code",[t._v("Lanes")]),t._v("是一个不透明的类型，只能在"),a("code",[t._v("ReactFiberLanes.js")]),t._v("这个模块中维护，如果要在其他文件中使用，只能通过"),a("code",[t._v("ReactFiberLanes.js")]),t._v("中提供的工具函数来使用。")])])]),t._v(" "),a("p",[t._v("分析车道模型的源码("),a("code",[t._v("ReactFiberLane.js")]),t._v("中)，可以得到如下结论：")]),t._v(" "),a("ol",[a("li",[t._v("可以使用的比特位一共有 31 位(为什么？可以参考"),a("a",{attrs:{href:"../algorithm/%E4%BD%8D%E8%BF%90%E7%AE%97"}},[t._v("React 算法之位运算")]),t._v("中的说明)。")]),t._v(" "),a("li",[t._v("共定义了"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberLane.js#L74-L103",target:"_blank",rel:"noopener noreferrer"}},[t._v("18 种车道"),a("OutboundLink")],1),t._v("("),a("code",[t._v("Lane/Lanes")]),t._v(")变量，每一个变量占有 1 个或多个比特位，分别定义为"),a("code",[t._v("Lane")]),t._v("和"),a("code",[t._v("Lanes")]),t._v("类型")]),t._v(" "),a("li",[t._v("每一种车道("),a("code",[t._v("Lane/Lanes")]),t._v(")都有对应的优先级，所以源码中定义了18种优先级("),a("code",[t._v("LanePriority")]),t._v(")")]),t._v(" "),a("li",[t._v("占有低位比特位的"),a("code",[t._v("Lane")]),t._v("变量对应的优先级越高\n"),a("ul",[a("li",[t._v("最高优先级为"),a("code",[t._v("SyncLanePriority")]),t._v("对应的车道为"),a("code",[t._v("SyncLane = 0b0000000000000000000000000000001")])]),t._v(" "),a("li",[t._v("最低优先级为"),a("code",[t._v("OffscreenLanePriority")]),t._v("对应的车道为"),a("code",[t._v("OffscreenLane = 0b1000000000000000000000000000000")])])])])]),t._v(" "),a("h2",{attrs:{id:"优先级区别和联系"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优先级区别和联系"}},[t._v("#")]),t._v(" 优先级区别和联系")]),t._v(" "),a("p",[t._v("在源码中，3 种优先级位于不同的 js 文件，是相互独立的。")]),t._v(" "),a("p",[t._v("注意：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("LanePriority")]),t._v("和"),a("code",[t._v("SchedulerPriority")]),t._v("从命名上看，它们代表的是"),a("code",[t._v("优先级")]),t._v("。")]),t._v(" "),a("li",[a("code",[t._v("ReactPriorityLevel")]),t._v("从命名上看，它代表的是"),a("code",[t._v("等级")]),t._v("而不是优先级，它用于衡量"),a("code",[t._v("LanePriority")]),t._v("和"),a("code",[t._v("SchedulerPriority")]),t._v("的等级")])]),t._v(" "),a("h3",{attrs:{id:"lanepriority"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#lanepriority"}},[t._v("#")]),t._v(" LanePriority")]),t._v(" "),a("p",[a("code",[t._v("LanePriority")]),t._v("：属于"),a("code",[t._v("react-reconciler")]),t._v("包，定义于"),a("code",[t._v("ReactFiberLane.js")]),t._v("。")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" SyncLanePriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" LanePriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" SyncBatchedLanePriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" LanePriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" InputDiscreteHydrationLanePriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" LanePriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("13")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" InputDiscreteLanePriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" LanePriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// .....")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" OffscreenLanePriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" LanePriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" NoLanePriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" LanePriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("与"),a("code",[t._v("fiber")]),t._v("构造过程相关的优先级(如"),a("code",[t._v("fiber.updateQueue")]),t._v("，"),a("code",[t._v("fiber.lanes")]),t._v(")都使用"),a("code",[t._v("LanePriority")]),t._v("。")]),t._v(" "),a("p",[t._v("由于本节重点介绍优先级体系以及它们的转换关系，关于"),a("code",[t._v("Lane(车道模型)")]),t._v("在"),a("code",[t._v("fiber树构造")]),t._v("时的具体使用，在"),a("code",[t._v("fiber 树构造")]),t._v("章节详细解读。")]),t._v(" "),a("h3",{attrs:{id:"schedulerpriority"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#schedulerpriority"}},[t._v("#")]),t._v(" SchedulerPriority")]),t._v(" "),a("p",[a("code",[t._v("SchedulerPriority")]),t._v("，属于"),a("code",[t._v("scheduler")]),t._v("包，定义于"),a("code",[t._v("SchedulerPriorities.js")]),t._v("中。")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" NoPriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" ImmediatePriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" UserBlockingPriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" NormalPriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" LowPriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" IdlePriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("与"),a("code",[t._v("scheduler")]),t._v("调度中心相关的优先级使用"),a("code",[t._v("SchedulerPriority")]),t._v("。")]),t._v(" "),a("h3",{attrs:{id:"reactprioritylevel"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#reactprioritylevel"}},[t._v("#")]),t._v(" ReactPriorityLevel")]),t._v(" "),a("p",[a("code",[t._v("reactPriorityLevel")]),t._v("，属于"),a("code",[t._v("react-reconciler")]),t._v("包，定义于"),a("code",[t._v("SchedulerWithReactIntegration.js")]),t._v("中。")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" ImmediatePriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ReactPriorityLevel "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("99")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" UserBlockingPriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ReactPriorityLevel "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("98")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" NormalPriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ReactPriorityLevel "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("97")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" LowPriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ReactPriorityLevel "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("96")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" IdlePriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ReactPriorityLevel "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("95")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// NoPriority is the absence of priority. Also React-only")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" NoPriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ReactPriorityLevel "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("90")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[a("code",[t._v("LanePriority")]),t._v("与"),a("code",[t._v("SchedulerPriority")]),t._v("通过"),a("code",[t._v("ReactPriorityLevel")]),t._v("进行转换。")]),t._v(" "),a("h3",{attrs:{id:"转换关系"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#转换关系"}},[t._v("#")]),t._v(" 转换关系")]),t._v(" "),a("p",[t._v("为了能协同调度中心("),a("code",[t._v("scheduler")]),t._v("包)和 fiber 树构造("),a("code",[t._v("react-reconciler")]),t._v("包)中对优先级的使用，则需要转换"),a("code",[t._v("SchedulerPriority")]),t._v("和"),a("code",[t._v("LanePriority")]),t._v("，转换的桥梁正是"),a("code",[t._v("ReactPriorityLevel")]),t._v("。")]),t._v(" "),a("p",[t._v("在"),a("code",[t._v("SchedulerWithReactIntegration.js")]),t._v("中，可以互转"),a("code",[t._v("SchedulerPriority")]),t._v("和"),a("code",[t._v("ReactPriorityLevel")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 把SchedulerPriority 转换成 ReactPriorityLevel")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getCurrentPriorityLevel")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ReactPriorityLevel "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Scheduler_getCurrentPriorityLevel")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" Scheduler_ImmediatePriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" ImmediatePriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" Scheduler_UserBlockingPriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" UserBlockingPriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" Scheduler_NormalPriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" NormalPriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" Scheduler_LowPriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" LowPriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" Scheduler_IdlePriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" IdlePriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("invariant")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Unknown priority level.'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 把 ReactPriorityLevel 转换成 SchedulerPriority")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("reactPriorityToSchedulerPriority")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("reactPriorityLevel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("reactPriorityLevel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" ImmediatePriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Scheduler_ImmediatePriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" UserBlockingPriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Scheduler_UserBlockingPriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" NormalPriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Scheduler_NormalPriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" LowPriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Scheduler_LowPriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" IdlePriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Scheduler_IdlePriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("invariant")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Unknown priority level.'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("在"),a("code",[t._v("ReactFiberLane.js")]),t._v("中，可以互转"),a("code",[t._v("LanePriority")]),t._v("和"),a("code",[t._v("ReactPriorityLevel")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("schedulerPriorityToLanePriority")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\tschedulerPriorityLevel"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ReactPrioritylevel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" LanePriority "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("schedulerPriorityLevel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" ImmediateSchedulerPriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" SyncLanePriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省略部分代码")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n     \t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" NoLanePriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("lanePriorityToSchedulerPriority")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\tlanePriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" LanePriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ReactPriorityLevel "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("lanePriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" SyncLanePriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" SyncBatchedLanePriority"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" ImmediateSchedulerPriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ... 省略部分代码")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("invariant")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Invalid update priority: %s. This is a bug in React.'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        lanePriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"优先级使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优先级使用"}},[t._v("#")]),t._v(" 优先级使用")]),t._v(" "),a("p",[t._v("通过reconciler 运作流程的归纳，"),a("code",[t._v("reconciler")]),t._v("从输入到输出一共经历了 4 个阶段，在每个阶段中都会涉及到与"),a("code",[t._v("优先级")]),t._v("相关的处理。正式通过"),a("code",[t._v("优先级")]),t._v("的灵活运用，"),a("code",[t._v("React")]),t._v("实现了"),a("code",[t._v("可中断渲染")]),t._v("，"),a("code",[t._v("时间切片(time slicing)")]),t._v("，"),a("code",[t._v("异步渲染(suspense)")]),t._v("等特性。")]),t._v(" "),a("p",[t._v("在理解了优先级的基本思路之后，接下来就正式进入 react 源码分析中的硬核部分("),a("code",[t._v("scheduler 调度原理")]),t._v("和"),a("code",[t._v("fiber 树构造")]),t._v(")")]),t._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("p",[t._v("本文介绍了 react 源码中有关优先级的部分，并梳理了 3 种优先级之间的区别和联系。它们贯穿了reconciler运作流程中的 4 个阶段，在 react 源码中所占用的代码量比较高，理解它们的设计思路，为接下来分析"),a("code",[t._v("调度原理")]),t._v("和"),a("code",[t._v("fiber")]),t._v("构造打下基础。")])])}),[],!1,null,null,null);s.default=r.exports}}]);