---
title: 宏观包结构
---

# React 应用的宏观包结构(web 开发)

> React 工程目录的packages下包含35个包。
>
> 其中与`web`开发相关的核心包共有4个，本篇以这四个包为线索展开，深入react内部原理。

## 基础包结构

### react

react基础包，只提供定义react组件(`createElement`)的必要函数，一般来说需要和渲染器(`react-dom`、`react-native`)一同使用，在编写react应用的代码时，大部分都是调用此包的api。

### react-dom

react渲染器之一，是react与web平台连接的桥梁(可以在浏览器和nodejs环境中使用)，将`react-reconciler`中的运行结果输出到web界面上，在编写`react`应用的代码时，大多数场景下，能用到此包的就是一个入口函数`ReactDOM.render(<App/>, document.getElementById('root'))`，其余使用的API，基本上是`react`包提供的。

### react-reconciler

react得以运行的核心包(综合协调`react-dom`，`react`，`scheduler`各包之间的调用与配合)。

管理react应用状态的输入和结果的输出，将输入信号最终转换为输出信号传递给渲染器。

* 接受输入(`scheduleUpdateOnFiber`)，将`fiber`树生成逻辑封装到一个回调函数中(涉及`fiber`树形结构)，`fiber.updateQueue`队列，调和算法等）
* 把此回调函数(`performSyncWorkRoot`或`performConcurrentWorkOnRoot`)送入`scheduler`进行调度
* `scheduler`会控制回调函数执行的时机，回调函数执行完成后得到全新的fiber树
* 再调用渲染器(如`react-dom`，`react-native`等)将fiber树形结构最终反应到界面上

### scheduler

调度机制的核心实现，控制由`react-reconciler`送入的回调函数的执行时机，在`concurrent`模式下可以实现任务分片，在编写`react`应用的代码时，同样几乎不会直接用到此包提供的api。

* 核心任务就是执行回调(回调函数由`react-reconciler`提供)
* 通过控制回调函数的执行时机，来达到任务分片的目的，实现可中断渲染(`concurrent`模式下才有此特性)

## 宏观总览

### 架构分层

为了便于理解，可将react应用整体结构分为接口层(`api`)和内核层(`core`)2个部分。

#### 接口层(api)

`react`包，平时在开发过程中使用的绝大部分`api`均来自此包，在`react`启动之后，正常可以改变渲染的基本操作有3个。

* class 组件中使用`setState()`
* function 组件里面使用hook，并发起`dispatchAction`去改变hook对象
* 改变 context(其实也需要`setState`或`dispatchAction`的辅助才能改变)

以上`setState`和`dispatchAction`都由`react`包直接暴露，所以想要react工作，基本上都是调用`react`包的api与其他包进行交互。

#### 内核层(core)

整个内核部分，由3部分构成：

* 调度器：`scheduler`包，核心职责只有1个，就是执行回调。
  * 把`react-reconciler`提供的回调函数，包装到一个任务对象中。
  * 在内部维护一个任务队列，优先级高的排在最前面。
  * 循环消费任务队列，直到队列清空。
* 构造器：`react-reconciler`包，有3个核心职责。
  * 装载渲染器，渲染器必须实现`HostConfig`协议(如:`react-dom`)，保证在需要的时候，能够正确调用渲染器的api，生成实际节点(如:`dom`节点)。
  * 接受`react-dom`包(初次`render`)和`react`包(后续更新`state`)发起的更新请求。
  * 将`fiber`树的构造过程包装在一个回调函数中，并将此回调函数传入到`scheduler`包等待调度。
* 渲染器：`react-dom`包，有2个核心职责。
  * 引导`react`应用的启动。(通过`ReactDOM.render`)
  * 实现`HostConfig`协议(源码在ReactDOMHostConfig.js中)，能够将`react-reconciler`包构造出来的`fiber`树表现出来，生成dom节点(浏览器中)，生成字符串(ssr)

### 内核关系

现将内核3个包的主要职责和调用关系，绘制到一张概览图上：

![](https://raw.githubusercontent.com/yuhongjing/img-folder/master/img/core-packages.c2850581.png)

注意：

* 红色方块代表入口函数，绿色方块代表出口函数。
* package之间的调用脉络就是通过板块间的入口和出口函数连接起来的。

